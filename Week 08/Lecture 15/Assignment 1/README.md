# Assignment 1 - Lecture 13

Research about `OncePerRequestFilter` in spring boot, and give the example. [Full-Code](assignment1/src/main/java/com/example/lecture10/assignment1/)

## Example of OncePerRequestFilter

**OncePerRequestFilter** is a type of filter that ensures a filter is invoked only once per request. This is useful when a request may be forwarded to multiple servlets that could potentially trigger the same filter multiple times. By extending `OncePerRequestFilter`, the filter is executed only once per request.

In this section, I'll give the example of demonstration of `OncePerRequestFilter` in Spring Boot. This filter ensures that a particular action (that is logging in this example) is executed only once for each `HTTP request`.

### Greeting Controller

The `GreetingController` that demonstrates request handling. [GreetingController.java](assignment1/src/main/java/com/example/lecture10/assignment1/controller/GreetingController.java)

```java
@Controller
public class GreetingController {

    private final ExecutorService executorService = Executors.newFixedThreadPool(10);

    @GetMapping(path = "/greeting")
    public DeferredResult<String> greeting(HttpServletResponse response) {
        DeferredResult<String> deferredResult = new DeferredResult<>();
        executorService.submit(() -> perform(deferredResult));
        return deferredResult;
    }

    private void perform(DeferredResult<String> deferredResult) {
        deferredResult.setResult("Hello, World!");
    }
}
```

This controller manages requests to `/greeting` by using `DefferedResult<String>` for asynchronous response handling. It creates a `DefferedResult`, submit a task to the `ExecutorService` that setting the result to "Hello, World".

### CustomLoggingFilter Synchronous

This `CustomLoggingFilter` operates in a synchronous context. [CustomLoggingFilter.java](assignment1/src/main/java/com/example/lecture10/assignment1/filter/CustomLoggingFilter.java)

```java
@Component
public class CustomLoggingFilter extends OncePerRequestFilter {
    // ...
}
```

The `CustomLoggingFilter` class extends the `OncePerRequestFilter` to ensure that the filter is executed only once per request.

```java
@Component
public class CustomLoggingFilter extends OncePerRequestFilter {

    private static final Logger logger = LoggerFactory.getLogger(CustomLoggingFilter.class);

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        logger.info("Inside OncePerRequestFilter originated by request {}", request.getRequestURI());
        filterChain.doFilter(request, response);
    }

    // ...
}
```

In the `doFilterInternal()` method, there is a log entry that is created when a request passes through this filter. The log will includes the `URI` of the incoming request path that being accessed. After that, the filter chain proceed by calling `filterChain.doFilter(request, response)` allowing the request to continue the process.

```java
@Component
public class CustomLoggingFilter extends OncePerRequestFilter {

    // ...

    @Override
    protected boolean shouldNotFilterAsyncDispatch() {
        return true;
    }
}
```

The `shouldNotFilterAsyncDispatch()` method that returning `true` indicates that the filter should not be applied to `asynchronous` dispatches. Ensuring the filter does not log multiple times based on the thread for the same request for asynchronous processing.

#### Result (Synchronous)

The log output that generated by the `CustomLoggingFilter` during synchronous request processing.

```log
2024-07-29T11:04:07.543+07:00  INFO 12948 --- [assignment1] [nio-8080-exec-1] c.e.l.a.filter.CustomLoggingFilter       : Inside OncePerRequestFilter originated by request /greeting
```

This log entry confirms that the `CustomLoggingFilter` is executed once for the request. The filter logged the `URI`, showing that each request is processed and logged only once during `synchronous` operations.

### CustomLoggingFilter Asynchronous

This `CustomLoggingFilter` operates in a asynchronous context. Handle where request may be dispatched multiple times due to asynchronous operations. [CustomLoggingFilter.java](assignment1/src/main/java/com/example/lecture10/assignment1/filter/CustomLoggingFilter.java)

```java
@Component
public class CustomLoggingFilter extends OncePerRequestFilter {

    // ...

    @Override
    protected boolean shouldNotFilterAsyncDispatch() {
        return false;
    }
}
```

The `shouldNotFilterAsyncDispatch` method that returns `false` indicates that the filter should be applied to asynchronous requests as well. Also, the filter will execute for both synchronous and asynchronous request dispatches, ensuring consistent logging across all types of request processing.

#### Result (Asynchronous)

The log output that generated by the `CustomLoggingFilter` during asynchronous request processing.

```log
2024-07-29T11:43:57.872+07:00  INFO 20092 --- [assignment1] [nio-8080-exec-1] c.e.l.a.filter.CustomLoggingFilter       : Inside OncePerRequestFilter originated by request /greeting
2024-07-29T11:43:57.875+07:00  INFO 20092 --- [assignment1] [nio-8080-exec-2] c.e.l.a.filter.CustomLoggingFilter       : Inside OncePerRequestFilter originated by request /greeting
```

In the `asynchronous` scenario, the logs show multiple entries due to the asynchronous request processing. The filter may be executed multiple times because of the different threads or stages of request handling.